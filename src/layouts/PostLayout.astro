---
import '@shikijs/twoslash/style-rich.css'
import '@/styles/mdx.css'

import type { CollectionEntry } from 'astro:content'
import { formatDate } from '@/lib/blog-utils'

import CopyCodeScript from '@/components/post/CopyCodeScript.astro'
import GiscusComment from '@/components/post/GiscusComment'
import MediumZoomScript from '@/components/post/MediumZoomScript.astro'
import PageActions from '@/components/post/PageActions'
import PostImage from '@/components/post/PostImage.astro'
import TableOfContent from '@/components/post/TableOfContent'
import SocialShare from '@/components/post/SocialShare'
import { generateDescription, parseToc } from '@/lib/mdx'
import LeftSidebar from '@/layouts/partials/LeftSidebar.astro'
import PostNavigation from '@/components/common/PostNavigation.astro'

import BaseLayout from './BaseLayout.astro'
import GoogleAdsense from '@/components/GoogleAdsense.astro'
import { WEBSITE_CONFIG } from '@/consts'

type Props = {
  post: CollectionEntry<'post'>
  prevPost?: CollectionEntry<'post'>
  nextPost?: CollectionEntry<'post'>
}

const { post, prevPost, nextPost } = Astro.props

const { title, date, image, tags } = post.data
const description = post.data.description || generateDescription(post.body)
const formattedDate = formatDate(date)
const toc = parseToc(post.body)

const { Content } = await post.render()

// BlogPosting JSON-LD Schema
const blogPostingSchema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": title,
  "description": description,
  "image": image ? new URL(image, Astro.site).toString() : new URL(WEBSITE_CONFIG.OG_IMAGE, Astro.site).toString(),
  "datePublished": new Date(date).toISOString(),
  "dateModified": new Date(date).toISOString(),
  "author": {
    "@type": "Person",
    "name": "매튜",
    "url": Astro.site?.toString()
  },
  "publisher": {
    "@type": "Organization",
    "name": "YOLOG",
    "logo": {
      "@type": "ImageObject",
      "url": new URL("/favicon.ico", Astro.site).toString()
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": Astro.url.toString()
  },
  ...(tags && tags.length > 0 ? { "keywords": tags.join(", ") } : {})
}
---

<BaseLayout seo={{ title, description, image, keywords: tags }}>
  <script type="application/ld+json" set:html={JSON.stringify(blogPostingSchema)} />
  <LeftSidebar>
    <a
      class="group flex w-fit items-center gap-1.5 text-third transition-colors hover:text-primary lg:gap-2"
      href="#"
      onclick="history.back(); return false;"
      data-animate
    >
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform group-hover:-translate-x-0.5"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
      <span class="text-sm">뒤로</span>
    </a>
    <div class="mt-6 lg:hidden">
      <TableOfContent
        className="text-sm"
        data-animate
        toc={toc}
        client:visible
      />
    </div>
    <div class="mt-auto pt-6 lg:mt-0 lg:pt-0">
      <PageActions client:idle />
    </div>
  </LeftSidebar>
  <section>
    <div class="pt-12 pb-8 sm:pt-8 sm:pb-6">
      <time datetime={formattedDate} class="text-xs text-third">{formattedDate}</time>
      <h1 class="mt-3 text-3xl font-bold tracking-tight leading-tight sm:text-2xl">{title}</h1>
      <div class="mt-6">
        <SocialShare
          title={title}
          url={Astro.url.href}
          client:visible
        />
      </div>
    </div>
  </section>
  <section>
    <article data-animate data-animate-speed="fast" class="mdx">
      <Content components={{ img: PostImage }} />
    </article>
    <GoogleAdsense
      slot="1234567890"
      className="my-8"
    />
    <footer class="px-0">
      <hr class="my-8 border-border" />
      <PostNavigation {prevPost} {nextPost} />
      <GiscusComment className="mx-auto my-half-page" client:idle />
    </footer>
  </section>
  <MediumZoomScript />
  <CopyCodeScript />
</BaseLayout>
