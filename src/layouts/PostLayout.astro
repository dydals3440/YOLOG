---
import '@shikijs/twoslash/style-rich.css'
import '@/styles/mdx.css'

import type { CollectionEntry } from 'astro:content'
import { formatDate } from '@/lib/blog-utils'

import CopyCodeScript from '@/components/post/CopyCodeScript.astro'
import GiscusComment from '@/components/post/GiscusComment'
import MediumZoomScript from '@/components/post/MediumZoomScript.astro'
import PageActions from '@/components/post/PageActions'
import PostImage from '@/components/post/PostImage.astro'
import TableOfContent from '@/components/post/TableOfContent'
import SocialShare from '@/components/post/SocialShare'
import { UndoIcon } from '@/components/ui/icons'
import { generateDescription, parseToc } from '@/lib/mdx'
import LeftSidebar from '@/layouts/partials/LeftSidebar.astro'
import PostNavigation from '@/components/common/PostNavigation.astro'

import BaseLayout from './BaseLayout.astro'
import GoogleAdsense from '@/components/GoogleAdsense.astro'

type Props = {
  post: CollectionEntry<'post'>
  prevPost?: CollectionEntry<'post'>
  nextPost?: CollectionEntry<'post'>
}

const { post, prevPost, nextPost } = Astro.props

const { title, date, image, tags } = post.data
const description = post.data.description || generateDescription(post.body)
const formattedDate = formatDate(date)
const toc = parseToc(post.body)

const { Content } = await post.render()
---

<BaseLayout seo={{ title, description, image, keywords: tags }}>
  <LeftSidebar>
    <a
      class="group flex w-fit items-center gap-2 rounded-lg px-3 py-2 transition-all hover:bg-gray-100"
      href="#"
      onclick="history.back(); return false;"
      data-animate
    >
      <UndoIcon 
        strokeWidth={1.5} 
        className="h-4 w-4 text-gray-600 transition-transform group-hover:-translate-x-0.5" 
      />
      <span class="font-serif text-sm font-medium text-gray-700 group-hover:text-gray-900">이전 페이지</span>
    </a>
    <div class="mt-8 border-l-2 border-gray-100 pl-4 lg:hidden">
      <h3 class="mb-3 font-serif text-sm font-semibold text-gray-900">목차</h3>
      <TableOfContent
        className="text-sm"
        data-animate
        toc={toc}
        client:visible
      />
    </div>
    <div class="mt-6">
      <PageActions client:idle />
    </div>
  </LeftSidebar>
  <section>
    <h1 class="mt-14">{title}</h1>
    <time datetime={formattedDate} class="text-sm">{formattedDate}</time>
    <div class="mt-6">
      <SocialShare
        title={title}
        url={Astro.url.href}
        client:visible
      />
    </div>
  </section>
  <section>
    <article data-animate data-animate-speed="fast" class="mdx mt-14">
      <Content components={{ img: PostImage }} />
    </article>
    <GoogleAdsense 
      slot="1234567890" 
      className="my-8" 
    />
    <footer class="px-0">
      <hr class="mb-7 mt-4" />
      <PostNavigation {prevPost} {nextPost} />
      <GiscusComment className="mx-auto my-half-page" client:idle />
    </footer>
  </section>
  <MediumZoomScript />
  <CopyCodeScript />
</BaseLayout>
