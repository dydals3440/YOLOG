---
import '@shikijs/twoslash/style-rich.css'
import '@/styles/mdx.css'

import type { CollectionEntry } from 'astro:content'
import { formatDate } from '@/lib/blog-utils'

import CopyCodeScript from '@/components/post/CopyCodeScript.astro'
import GiscusComment from '@/components/post/GiscusComment'
import MediumZoomScript from '@/components/post/MediumZoomScript.astro'
import PageActions from '@/components/post/PageActions'
import PostImage from '@/components/post/PostImage.astro'
import TableOfContent from '@/components/post/TableOfContent'
import SocialShare from '@/components/post/SocialShare'
import { UndoIcon } from '@/components/ui/icons'
import { generateDescription, parseToc } from '@/lib/mdx'
import LeftSidebar from '@/layouts/partials/LeftSidebar.astro'
import PostNavigation from '@/components/common/PostNavigation.astro'

import BaseLayout from './BaseLayout.astro'
import GoogleAdsense from '@/components/GoogleAdsense.astro'

type Props = {
  post: CollectionEntry<'post'>
  prevPost?: CollectionEntry<'post'>
  nextPost?: CollectionEntry<'post'>
}

const { post, prevPost, nextPost } = Astro.props

const { title, date, image, tags } = post.data
const description = post.data.description || generateDescription(post.body)
const formattedDate = formatDate(date)
const toc = parseToc(post.body)

const { Content } = await post.render()
---

<BaseLayout seo={{ title, description, image, keywords: tags }}>
  <LeftSidebar>
    <a
      class="group flex w-fit items-center gap-2 rounded-lg px-3 py-2 transition-colors hover:bg-hover"
      href="#"
      onclick="history.back(); return false;"
      data-animate
    >
      <UndoIcon
        strokeWidth={1.5}
        className="h-4 w-4 text-third transition-transform group-hover:-translate-x-0.5"
      />
      <span class="text-sm text-second group-hover:text-primary">뒤로</span>
    </a>
    <div class="mt-8 lg:hidden">
      <h3 class="mb-3 text-xs font-medium text-third uppercase tracking-wider">목차</h3>
      <TableOfContent
        className="text-sm"
        data-animate
        toc={toc}
        client:visible
      />
    </div>
    <div class="mt-6">
      <PageActions client:idle />
    </div>
  </LeftSidebar>
  <section>
    <div class="pt-12 pb-8 sm:pt-8 sm:pb-6">
      <time datetime={formattedDate} class="text-xs text-third">{formattedDate}</time>
      <h1 class="mt-3 text-3xl font-bold tracking-tight leading-tight sm:text-2xl">{title}</h1>
      <div class="mt-6">
        <SocialShare
          title={title}
          url={Astro.url.href}
          client:visible
        />
      </div>
    </div>
  </section>
  <section>
    <article data-animate data-animate-speed="fast" class="mdx">
      <Content components={{ img: PostImage }} />
    </article>
    <GoogleAdsense
      slot="1234567890"
      className="my-8"
    />
    <footer class="px-0">
      <hr class="my-8 border-border" />
      <PostNavigation {prevPost} {nextPost} />
      <GiscusComment className="mx-auto my-half-page" client:idle />
    </footer>
  </section>
  <MediumZoomScript />
  <CopyCodeScript />
</BaseLayout>
