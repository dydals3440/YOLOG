---
import { getCollection } from 'astro:content'

import BaseLayout from '@/layouts/BaseLayout.astro'
import { BLOG_CATEGORIES, type BlogCategory } from '@/consts'
import CategoryList from '@/components/blogs/CategoryList.astro'
import BlogCard from '@/components/blogs/BlogCard.astro'
import Pagination from '@/components/blogs/Pagination.astro'
import YongGlass from '@/components/YongGlass.astro'
import { sortPostsByDate, createCategoryList, filterPostsByCategory, paginateArray } from '@/lib/blog-utils'
import { PAGINATION, getSiteUrl } from '@/lib/config'

export async function getStaticPaths() {
  const allPosts = await getCollection('post')
  const categories = Object.keys(BLOG_CATEGORIES)
    .filter(category => category !== 'ALL')
    .map(category => category.toLowerCase())

  const paths = []

  // 전체 블로그 페이지네이션 (2페이지부터)
  const totalAllPages = Math.ceil(sortPostsByDate(allPosts).length / PAGINATION.POSTS_PER_PAGE)
  for (let page = 2; page <= totalAllPages; page++) {
    const { items: posts, pagination } = paginateArray(sortPostsByDate(allPosts), page, PAGINATION.POSTS_PER_PAGE)

    paths.push({
      params: { slug: `page/${page}` },
      props: {
        posts,
        pagination: {
          ...pagination,
          totalPosts: allPosts.length
        },
        categories: createCategoryList(allPosts),
        category: null,
        categoryLabel: 'All'
      }
    })
  }

  // 각 카테고리별 페이지네이션
  for (const category of categories) {
    const categoryKey = category.toUpperCase() as BlogCategory
    const filteredPosts = filterPostsByCategory(allPosts, categoryKey)
    const sortedPosts = sortPostsByDate(filteredPosts)

    const totalCategoryPages = Math.ceil(sortedPosts.length / PAGINATION.POSTS_PER_PAGE_CATEGORY)

    // 카테고리 1페이지
    const { items: firstPagePosts, pagination: firstPagination } = paginateArray(sortedPosts, 1, PAGINATION.POSTS_PER_PAGE_CATEGORY)
    paths.push({
      params: { slug: category },
      props: {
        posts: firstPagePosts,
        pagination: {
          ...firstPagination,
          totalPosts: sortedPosts.length
        },
        categories: createCategoryList(allPosts),
        category,
        categoryLabel: BLOG_CATEGORIES[categoryKey],
        totalPostsInCategory: sortedPosts.length
      }
    })

    // 카테고리 2페이지부터
    for (let page = 2; page <= totalCategoryPages; page++) {
      const { items: posts, pagination } = paginateArray(sortedPosts, page, PAGINATION.POSTS_PER_PAGE_CATEGORY)

      paths.push({
        params: { slug: `${category}/page/${page}` },
        props: {
          posts,
          pagination: {
            ...pagination,
            totalPosts: sortedPosts.length
          },
          categories: createCategoryList(allPosts),
          category,
          categoryLabel: BLOG_CATEGORIES[categoryKey],
          totalPostsInCategory: sortedPosts.length
        }
      })
    }
  }

  return paths
}

const { posts, pagination, categories, category, categoryLabel, totalPostsInCategory } = Astro.props

// URL 기반 경로 설정
const basePath = category ? `/blogs/${category}` : '/blogs'
const totalPosts = totalPostsInCategory || pagination.totalPosts

// 제목: 전체 페이지면 "전체", 카테고리면 카테고리 이름
const displayTitle = category ? categoryLabel : '전체'

// SEO: 페이지네이션 rel="prev/next" URL 계산
const siteUrl = getSiteUrl(Astro.site)
const currentPage = pagination.currentPage
const totalPages = pagination.totalPages

const getPrevUrl = () => {
  if (currentPage <= 1) return null
  if (currentPage === 2) {
    return category ? `${siteUrl}/blogs/${category}` : `${siteUrl}/blogs`
  }
  return category
    ? `${siteUrl}/blogs/${category}/page/${currentPage - 1}`
    : `${siteUrl}/blogs/page/${currentPage - 1}`
}

const getNextUrl = () => {
  if (currentPage >= totalPages) return null
  return category
    ? `${siteUrl}/blogs/${category}/page/${currentPage + 1}`
    : `${siteUrl}/blogs/page/${currentPage + 1}`
}

const prevUrl = getPrevUrl()
const nextUrl = getNextUrl()
---

<BaseLayout seo={{ prevUrl, nextUrl }}>
  <div class="py-12 sm:py-8">
    <div class="mb-12 sm:mb-8">
      <h1 class="text-3xl font-bold tracking-tight mb-2 sm:text-2xl">{displayTitle}</h1>
      <p class="text-second text-sm">
        {totalPosts}개의 글
      </p>
    </div>

    <div class="mb-10 sm:mb-8">
      <CategoryList categories={categories} currentPath={Astro.url.pathname} />
    </div>

    {posts.length > 0 ? (
      <div>
        <div class="divide-y divide-border">
          {posts.map(post => <BlogCard post={post} />)}
        </div>

        {pagination.totalPages > 1 && (
          <div class="mt-12">
            <Pagination pagination={pagination} basePath={basePath} />
          </div>
        )}
      </div>
    ) : (
      <div class="py-16 flex flex-col items-center justify-center text-center">
        <YongGlass className="w-24 h-24 mb-6" />
        <p class="text-second">
          해당하는 게시글이 없습니다.
        </p>
      </div>
    )}
  </div>
</BaseLayout>
